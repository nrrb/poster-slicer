<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Poster Slicer (Auto-load SVG + PNG, JPG)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { margin: 10px 0; display: block; }
    .output { margin-top: 20px; }
    .preview-container { margin-top: 20px; overflow: auto; max-width: 100%; border: 1px solid #ccc; position: relative; }
    .preview-canvas { display: block; }
    .preview-grid { position: absolute; top: 0; left: 0; pointer-events: none; }
    .preview-overlay { position: absolute; top: 0; left: 0; pointer-events: auto; }
  </style>
</head>
<body>

<h2>Poster Slicer (SVG, PNG, JPG + Default Load)</h2>
<p>Upload an SVG, PNG, or JPG, or use the default "delight.svg". Set width or height, and the other updates automatically. Click slices to download.</p>

<label>Upload Image (SVG, PNG, JPG): <input type="file" id="imageFile" accept=".svg,.png,.jpg,.jpeg"></label>
<label>Target Width (inches): <input type="number" id="targetWidth" value="34" step="0.1"></label>
<label>Target Height (inches): <input type="number" id="targetHeight" value="44" step="0.1"></label>

<div id="instructions" style="display:none; margin-top: 15px; font-weight: bold;">
  Click on each page below to download that part of the poster for printing.
</div>

<div class="preview-container" id="previewContainer" style="display:none;">
  <canvas id="previewCanvas" class="preview-canvas"></canvas>
  <canvas id="gridCanvas" class="preview-grid"></canvas>
  <div id="overlayContainer" class="preview-overlay"></div>
</div>

<script>
const DPI = 300;
let loadedImage = null;
let aspectRatio = 1;
let sliceLinks = [];

function inchesToPixels(inches) {
  return inches * DPI;
}

document.getElementById('imageFile').addEventListener('change', handleFileUpload);
document.getElementById('targetWidth').addEventListener('input', handleWidthChange);
document.getElementById('targetHeight').addEventListener('input', handleHeightChange);

// ðŸ”‘ Auto-load default "delight.svg" on page load
window.onload = () => loadImage('delight.svg');

async function handleFileUpload() {
  const fileInput = document.getElementById('imageFile');
  const file = fileInput.files[0];
  if (!file) return;

  const extension = file.name.split('.').pop().toLowerCase();

  if (extension === 'svg') {
    const svgText = await file.text();
    const svgBlob = new Blob([svgText], { type: 'image/svg+xml' });
    const svgUrl = URL.createObjectURL(svgBlob);
    loadImage(svgUrl);
  } else if (['png', 'jpg', 'jpeg'].includes(extension)) {
    const reader = new FileReader();
    reader.onload = (e) => loadImage(e.target.result);
    reader.readAsDataURL(file);
  } else {
    alert('Unsupported file type!');
  }
}

function loadImage(url) {
  const img = new Image();
  img.onload = () => {
    loadedImage = img;
    aspectRatio = img.width / img.height;
    const widthInches = parseFloat(document.getElementById('targetWidth').value);
    const heightInches = widthInches / aspectRatio;
    document.getElementById('targetHeight').value = heightInches.toFixed(2);
    updatePreviewAndSlices();
  };
  img.src = url;
}

function handleWidthChange() {
  if (!loadedImage) return;
  const widthInches = parseFloat(document.getElementById('targetWidth').value);
  const heightInches = widthInches / aspectRatio;
  document.getElementById('targetHeight').value = heightInches.toFixed(2);
  updatePreviewAndSlices();
}

function handleHeightChange() {
  if (!loadedImage) return;
  const heightInches = parseFloat(document.getElementById('targetHeight').value);
  const widthInches = heightInches * aspectRatio;
  document.getElementById('targetWidth').value = widthInches.toFixed(2);
  updatePreviewAndSlices();
}

function updatePreviewAndSlices() {
  createSlices();
  updatePreview();
}

function createSlices() {
  const widthInches = parseFloat(document.getElementById('targetWidth').value);
  const heightInches = parseFloat(document.getElementById('targetHeight').value);
  const totalWidthPx = inchesToPixels(widthInches);
  const totalHeightPx = inchesToPixels(heightInches);
  const sliceWidth = inchesToPixels(8.5);
  const sliceHeight = inchesToPixels(11);

  const canvas = document.createElement('canvas');
  canvas.width = totalWidthPx;
  canvas.height = totalHeightPx;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(loadedImage, 0, 0, totalWidthPx, totalHeightPx);

  sliceLinks = [];

  for (let row = 0; row < Math.ceil(totalHeightPx / sliceHeight); row++) {
    sliceLinks[row] = [];
    for (let col = 0; col < Math.ceil(totalWidthPx / sliceWidth); col++) {
      const sliceCanvas = document.createElement('canvas');
      sliceCanvas.width = sliceWidth;
      sliceCanvas.height = sliceHeight;
      const sliceCtx = sliceCanvas.getContext('2d');
      sliceCtx.fillStyle = 'white';
      sliceCtx.fillRect(0, 0, sliceWidth, sliceHeight);
      sliceCtx.drawImage(canvas, col * sliceWidth, row * sliceHeight, sliceWidth, sliceHeight, 0, 0, sliceWidth, sliceHeight);
      sliceLinks[row][col] = sliceCanvas.toDataURL('image/png');
    }
  }
}

function updatePreview() {
  const previewContainer = document.getElementById('previewContainer');
  const previewCanvas = document.getElementById('previewCanvas');
  const gridCanvas = document.getElementById('gridCanvas');
  const overlayContainer = document.getElementById('overlayContainer');

  const widthInches = parseFloat(document.getElementById('targetWidth').value);
  const heightInches = parseFloat(document.getElementById('targetHeight').value);
  const widthPx = inchesToPixels(widthInches);
  const heightPx = inchesToPixels(heightInches);

  const maxPreviewWidth = 800;
  const scale = Math.min(1, maxPreviewWidth / widthPx);
  const previewWidth = widthPx * scale;
  const previewHeight = heightPx * scale;

  previewCanvas.width = previewWidth;
  previewCanvas.height = previewHeight;
  gridCanvas.width = previewWidth;
  gridCanvas.height = previewHeight;

  const ctx = previewCanvas.getContext('2d');
  ctx.clearRect(0, 0, previewWidth, previewHeight);
  ctx.drawImage(loadedImage, 0, 0, previewWidth, previewHeight);

  const gridCtx = gridCanvas.getContext('2d');
  gridCtx.clearRect(0, 0, previewWidth, previewHeight);
  gridCtx.strokeStyle = 'rgba(0,0,0,0.5)';
  gridCtx.setLineDash([5, 5]);

  const sliceWidth = inchesToPixels(8.5) * scale;
  const sliceHeight = inchesToPixels(11) * scale;

  for (let x = sliceWidth; x < previewWidth; x += sliceWidth) {
    gridCtx.moveTo(x, 0);
    gridCtx.lineTo(x, previewHeight);
  }
  for (let y = sliceHeight; y < previewHeight; y += sliceHeight) {
    gridCtx.moveTo(0, y);
    gridCtx.lineTo(previewWidth, y);
  }
  gridCtx.stroke();

  overlayContainer.innerHTML = '';
  sliceLinks.forEach((row, rIdx) => row.forEach((link, cIdx) => {
    const a = document.createElement('a');
    a.href = link;
    a.download = `poster_row${rIdx + 1}_col${cIdx + 1}.png`;
    Object.assign(a.style, { position: 'absolute', left: `${cIdx * sliceWidth}px`, top: `${rIdx * sliceHeight}px`, width: `${sliceWidth}px`, height: `${sliceHeight}px` });
    overlayContainer.appendChild(a);
  }));

  previewContainer.style.display = 'block';
  document.getElementById('instructions').style.display = 'block';
}
</script>

</body>
</html>
